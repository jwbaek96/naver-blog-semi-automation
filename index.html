<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§›ì§‘ ë¸”ë¡œê·¸ AI ë¹„ì„œ (GAS ë³´ì•ˆë²„ì „)</title>
    <style>
        :root { --primary: #03cf5d; --bg: #f5f6f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); }
        label { font-weight: bold; display: block; margin: 15px 0 5px; }
        input, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; }
        button:disabled { background: #ccc; }
        #loading { display: none; text-align: center; margin: 20px 0; color: #666; font-size: 14px; }
        .result-section { display: none; margin-top: 25px; border-top: 2px solid #eee; padding-top: 20px; }
        .result-box { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; white-space: pre-wrap; font-size: 14px; max-height: 300px; overflow-y: auto; }
        .copy-btn { background: #333; font-size: 13px; padding: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ³ ë§›ì§‘ ë¸”ë¡œê·¸ AI</h2>
    <p style="font-size: 12px; color: gray; text-align: center;">ì‚¬ì§„ì„ ë¶„ì„í•´ ì •ì„±ìŠ¤ëŸ° í›„ê¸°ë¥¼ ì¨ë“œë ¤ìš”</p>
    
    <label>ë§›ì§‘ í‚¤ì›Œë“œ</label>
    <input type="text" id="keyword" placeholder="ì˜ˆ: ì—°ë‚¨ë™ í…ë™ ë§›ì§‘ ì €ìŠ¤íŠ¸í…ë™">

    <label>ìŒì‹ ì‚¬ì§„ (ì—¬ëŸ¬ ì¥ ì„ íƒ)</label>
    <input type="file" id="imageInput" accept="image/*" multiple>

    <button id="generateBtn" onclick="generatePost()">í¬ìŠ¤íŒ… ìƒì„± ì‹œì‘</button>

    <div id="loading">ğŸ“¡ êµ¬ê¸€ ì„œë²„ë¥¼ í†µí•´ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</div>

    <div id="resultSection" class="result-section">
        <label>ğŸ“Œ ì œëª©</label>
        <div id="resTitle" class="result-box"></div>
        <button class="copy-btn" onclick="copyText('resTitle')">ì œëª© ë³µì‚¬</button>

        <label>ğŸ“ ë³¸ë¬¸</label>
        <div id="resContent" class="result-box"></div>
        <button class="copy-btn" onclick="copyText('resContent')">ë³¸ë¬¸ ë³µì‚¬</button>
    </div>
</div>

<script>
    // âš ï¸ ë°°í¬í•œ Google Apps Scriptì˜ ì›¹ ì•± URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxeuvBgWeCSwP7_jR66l0ppLZS8ZOdo4kozP1Bn56c2hsGQLY7OCVnVqYN51n96-lUt/exec";

    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ë° ì••ì¶• í•¨ìˆ˜
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > 1024) { height *= 1024 / width; width = 1024; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                };
            };
        });
    }

    async function generatePost() {
        const keyword = document.getElementById('keyword').value;
        const files = document.getElementById('imageInput').files;
        const btn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');

        if (!keyword || files.length === 0) return alert("í‚¤ì›Œë“œì™€ ì‚¬ì§„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        btn.disabled = true;
        loading.style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';

        try {
            // 1. ëª¨ë“  ì‚¬ì§„ ì••ì¶• ë° Base64 ë³€í™˜
            const images = await Promise.all([...files].map(compressImage));

            // 2. ë§›ì§‘ íŠ¹í™” í”„ë¡¬í”„íŠ¸
            const prompt = `
            ì‚¬ìš©ìê°€ ì œê³µí•œ ${images.length}ì¥ì˜ ì‚¬ì§„ê³¼ í‚¤ì›Œë“œ '${keyword}'ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ì„ ì‘ì„±í•´ì¤˜.
            
            [í•„ìˆ˜ ì¤€ìˆ˜ ì‚¬í•­]
            1. **ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì‚¬ìš© ê¸ˆì§€**: **, *, __, > ë“±ì˜ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ë¥¼ ë³¸ë¬¸ ì„¤ëª…ì— ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆ. ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì—ë””í„°ëŠ” ë§ˆí¬ë‹¤ìš´ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ì™€ ì¤„ë°”ê¿ˆìœ¼ë¡œë§Œ ê°€ë…ì„±ì„ ë†’ì—¬ì¤˜.
            2. **í•´ì‹œíƒœê·¸ í—ˆìš©**: ë‹¨, í¬ìŠ¤íŒ… ë§¨ ë§ˆì§€ë§‰ì— ë“¤ì–´ê°€ëŠ” 'í•´ì‹œíƒœê·¸' ëª©ì ì˜ # ê¸°í˜¸ëŠ” ì˜ˆì™¸ë¡œ í—ˆìš©í•´.
            3. **ì‚¬ì§„ ë°°ì¹˜ ë°©ì‹**: ì‚¬ì§„ì´ ë“¤ì–´ê°ˆ ìœ„ì¹˜ì— ë”± ì´ í˜•ì‹ìœ¼ë¡œë§Œ í‘œì‹œí•´: [ì‚¬ì§„1], [ì‚¬ì§„2], ... [ì‚¬ì§„${images.length}]. 
            4. **ìì—°ìŠ¤ëŸ¬ìš´ íë¦„**: "[ì‚¬ì§„1]ì„ ë³´ì„¸ìš”" í˜¹ì€ "ì´ë¯¸ì§€ë¥¼ ì´¬ì˜í–ˆìŠµë‹ˆë‹¤" ê°™ì€ 'ì‚¬ì§„ì— ëŒ€í•œ ì„¤ëª…'ì„ ë¬¸ì¥ì— í¬í•¨í•˜ì§€ ë§ˆ. ì‚¬ì§„ì´ ê·¸ ìë¦¬ì— ìˆëŠ” ê²ƒì²˜ëŸ¼ ë¬¸ë§¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ê°€ì¤˜. 
               (ì˜ˆ: "ì…êµ¬ë¶€í„° ë§›ì§‘ í¬ìŠ¤ê°€ ëŠê»´ì§€ë„¤ìš”. [ì‚¬ì§„1] ì‹¤ë‚´ë¡œ ë“¤ì–´ê°€ë‹ˆ ê¹”ë”í•œ ì¸í…Œë¦¬ì–´ê°€ ë°˜ê²¨ì¤ë‹ˆë‹¤.")
            5. **ëª¨ë“  ì‚¬ì§„(ì´ ${images.length}ì¥) í™œìš©**: ì „ì†¡ëœ ${images.length}ì¥ì˜ ì‚¬ì§„ ìˆœì„œì— ë§ì¶° ë³¸ë¬¸ ë‚´ìš©ì„ êµ¬ì„±í•˜ê³ , ëª¨ë“  ì‚¬ì§„ ë²ˆí˜¸ê°€ ë³¸ë¬¸ì— ê³¨ê³ ë£¨ í¬í•¨ë˜ì–´ì•¼ í•´. 
            6. ë¸”ë¡œê±°ìŠ¤ëŸ¬ìš´ ê°ì„±: ì¹œê·¼í•˜ê³  ì”ë§ìŠ¤ëŸ½ê³  ë”°ëœ»í•œ ì–´ì¡°ë¡œ ì‘ì„±í•´. ë§ˆì¹˜ ì¹œêµ¬ì—ê²Œ ì¶”ì²œí•˜ëŠ” ê²ƒì²˜ëŸ¼ ë§ì´ì•¼. + ì¦ì€ ì¤„ë°”ê¿ˆ ì‚¬ìš©
            
            [í¬ìŠ¤íŒ… êµ¬ì„±]
            - ì œëª©: í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ í´ë¦­ì„ ìœ ë„í•˜ëŠ” ì œëª© (íŠ¹ìˆ˜ê¸°í˜¸ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ)
            - ë³¸ë¬¸: ë„ì…ë¶€ - ì‚¬ì§„ë³„ ìƒì„¸ í›„ê¸°(ëª¨ë“  ì‚¬ì§„ í¬í•¨) - ë§ˆë¬´ë¦¬ ì¸ì‚¬
            - ë§ˆì§€ë§‰: #í‚¤ì›Œë“œ #ë§›ì§‘ì¶”ì²œ í˜•ì‹ì˜ í•´ì‹œíƒœê·¸ 5~8ê°œ
            `;

            // 3. GAS ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ prompt, images })
            });

            if (!response.ok) {
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (ìƒíƒœì½”ë“œ: ${response.status})`);
            }

            const data = await response.json();
            console.log("Server Response:", data); // ì‘ë‹µ í™•ì¸ìš© ë¡œê·¸

            if (!data.candidates || data.candidates.length === 0) {
                throw new Error(data.error?.message || "AI ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. GAS ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

            const fullText = data.candidates[0].content.parts[0].text;

            // 4. ê²°ê³¼ íŒŒì‹± ë° ì¶œë ¥
            const title = fullText.match(/ì œëª©:(.*)\n/)?.[1] || keyword + " ì†”ì§ ë°©ë¬¸ í›„ê¸°";
            const content = fullText.split(/ë³¸ë¬¸:/)[1] || fullText;

            document.getElementById('resTitle').innerText = title.trim();
            document.getElementById('resContent').innerText = content.trim();
            document.getElementById('resultSection').style.display = 'block';

        } catch (err) {
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            console.error(err);
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => alert("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }
</script>

</body>
</html>